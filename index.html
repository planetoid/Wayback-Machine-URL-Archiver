<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wayback Machine URL Archiver | 網頁備份工具</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 20px;
            background-color: #f9f9f9;
        }
        textarea {
            width: 100%;
            min-height: 150px;
            margin-bottom: 10px;
            padding: 10px;
            box-sizing: border-box;
        }
        input[type="text"] {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            box-sizing: border-box;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        #fileInput {
            margin-bottom: 10px;
        }
        #results {
            margin-top: 20px;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
        }
        .status-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
        }
        .status-table th {
            background-color: #f2f2f2;
            text-align: left;
            padding: 8px;
            border: 1px solid #ddd;
        }
        .status-table td {
            padding: 8px;
            border: 1px solid #ddd;
            vertical-align: middle;
        }
        .status-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .status-icon {
            font-size: 18px;
            text-align: center;
        }
        .status-label {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-success {
            background-color: #d4edda;
            color: #155724;
        }
        .status-warning {
            background-color: #fff3cd;
            color: #856404;
        }
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .status-info {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        .details-toggle {
            cursor: pointer;
            color: #0066cc;
        }
        .details-toggle:hover {
            text-decoration: underline;
        }
        .url-cell {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .details-row {
            display: none;
        }
        .details-content {
            padding: 10px;
            background-color: #f5f5f5;
            border-top: 1px solid #ddd;
        }
        .log-details {
            margin-top: 5px;
            padding: 8px;
            background-color: #f5f5f5;
            border-radius: 4px;
            display: none;
        }
        .success {
            border-left-color: #4CAF50;
            background-color: #f0fff0;
        }
        .warning {
            border-left-color: #ff9800;
            background-color: #fff9e6;
        }
        .error {
            border-left-color: #f44336;
            background-color: #fff0f0;
        }
        .info {
            border-left-color: #2196F3;
            background-color: #f0f8ff;
        }
        .progress-container {
            width: 100%;
            background-color: #ddd;
            margin-top: 10px;
            display: none;
        }
        .progress-bar {
            height: 20px;
            background-color: #4CAF50;
            text-align: center;
            line-height: 20px;
            color: white;
            width: 0%;
        }
        .eta {
            margin-top: 5px;
            font-style: italic;
        }
        .status-icon {
            margin-right: 10px;
            font-size: 18px;
            width: 24px;
            height: 24px;
            text-align: center;
            line-height: 24px;
        }
        .expand-icon {
            margin-left: auto;
            font-size: 16px;
            color: #666;
        }
        .url-text {
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        a {
            color: #0066cc;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        .language-selector {
            position: absolute;
            top: 20px;
            right: 20px;
        }
        .language-btn {
            background-color: #e7e7e7;
            color: black;
            padding: 6px 12px;
            margin-left: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .language-btn.active {
            background-color: #4CAF50;
            color: white;
        }
        
        /* Fixed language selection CSS */
        .en, .zh {
            display: none;
        }
        
        /* When language is English */
        [lang="en"] .en {
            display: block;
        }
        [lang="en"] span.en {
            display: inline;
        }
        
        /* When language is Chinese */
        [lang="zh"] .zh {
            display: block;
        }
        [lang="zh"] span.zh {
            display: inline;
        }

        [lang="zh"] .en {
            display: none;
        }
        [lang="zh"] span.en {
            display: none;
        }
        
        /* Ensure table headers and cells display correctly */
        th .en, th .zh, td .en, td .zh {
            display: none;
        }
        [lang="en"] th .en, [lang="en"] td .en {
            display: inline;
        }
        [lang="zh"] th .zh, [lang="zh"] td .zh {
            display: inline;
        }
    </style>
</head>
<body lang="en">
    <div class="language-selector">
        <button id="en-btn" class="language-btn active">English</button>
        <button id="zh-btn" class="language-btn">繁體中文</button>
    </div>

    <div class="container">
        <h1>
            <span class="en">Wayback Machine URL Archiver</span>
            <span class="zh">網頁備份工具</span>
        </h1>
        
        <div>
            <h3 class="en">Step 1: Enter URLs or Upload File</h3>
            <h3 class="zh">步驟 1: 輸入網址或上傳檔案</h3>
            <p class="en">Enter URLs (one per line) or upload a TXT/CSV file:</p>
            <p class="zh">輸入網址（每行一個）或上傳 TXT/CSV 檔案：</p>
            <textarea id="urlList" placeholder="https://example.com&#10;https://another-example.com"></textarea>
            <p class="en">Or upload a file:</p>
            <p class="zh">或上傳檔案：</p>
            <input type="file" id="fileInput" accept=".txt,.csv">
        </div>
        
        <div>
            <h3 class="en">Step 2: Enter Wayback Machine API Key (Optional)</h3>
            <h3 class="zh">步驟 2: 輸入 Wayback Machine API 金鑰（選填）</h3>
            <input type="text" id="apiKey" placeholder="Optional: Your Wayback Machine API Key">
            <p class="hint en" style="font-size: 0.8em; color: #666;">An API key may provide better rate limits, but is not required.</p>
            <p class="hint zh" style="font-size: 0.8em; color: #666;">(非必須) 使用 API 金鑰可能會提供更好的請求限制</p>
        </div>
        
        <div>
            <h3 class="en">Step 3: Start Archiving</h3>
            <h3 class="zh">步驟 3: 開始備份</h3>
            <button id="startButton">
                <span class="en">Start Archiving</span>
                <span class="zh">開始備份</span>
            </button>
            <button id="stopButton" style="background-color: #f44336; display: none;">
                <span class="en">Stop</span>
                <span class="zh">停止</span>
            </button>
        </div>
        
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar" id="progressBar">0%</div>
            <div class="eta" id="eta"></div>
        </div>
        
        <div id="results">
            <h3 class="en">Archive Results</h3>
            <h3 class="zh">備份結果</h3>
            <table class="status-table" id="archiveStatusTable">
                <thead>
                    <tr>
                        <th style="width: 40px;" class="col-no">
                            <span class="en">No.</span>
                            <span class="zh">編號</span>
                        </th>
                        <th class="col-url">
                            <span class="en">URL</span>
                            <span class="zh">網址</span>
                        </th>
                        <th style="width: 100px;" class="col-status">
                            <span class="en">Status</span>
                            <span class="zh">狀態</span>
                        </th>
                        <th style="width: 110px;" class="col-view">
                            <span class="en">View Archive</span>
                            <span class="zh">查看備份</span>
                        </th>
                        <th style="width: 80px;" class="col-details">
                            <span class="en">Details</span>
                            <span class="zh">詳細資訊</span>
                        </th>
                    </tr>
                </thead>
                <tbody id="statusTableBody">
                    <!-- Status rows will be added here dynamically -->
                </tbody>
            </table>
            <div id="logEntries" style="display: none;">
                <!-- Legacy log entries for compatibility -->
            </div>
            <div id="manualLinkContainer" style="display: none;"></div>
        </div>

        <div class="alternate-method" style="background-color: #d4edda; color: #155724; padding: 10px; border-radius: 4px; margin-top: 15px;">
            <strong class="en">Alternative Method:</strong>
            <strong class="zh">替代方法：</strong>
            <span class="en">You can also directly use the following format to manually archive a URL:</span>
            <span class="zh">您也可以直接使用以下格式手動存檔網址：</span><br>
            <code>https://web.archive.org/save/YOUR_URL_HERE</code>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Language selection
            const enBtn = document.getElementById('en-btn');
            const zhBtn = document.getElementById('zh-btn');
            const body = document.body;
            
            function setLanguage(lang) {
                body.setAttribute('lang', lang);
                if (lang === 'en') {
                    enBtn.classList.add('active');
                    zhBtn.classList.remove('active');
                } else {
                    zhBtn.classList.add('active');
                    enBtn.classList.remove('active');
                }
                localStorage.setItem('preferred-language', lang);
                console.log(`Language set to: ${lang}`);
            }
            
            enBtn.addEventListener('click', function() {
                setLanguage('en');
            });
            
            zhBtn.addEventListener('click', function() {
                setLanguage('zh');
            });
            
            // Load preferred language from localStorage
            const preferredLanguage = localStorage.getItem('preferred-language') || 'en';
            setLanguage(preferredLanguage);
            
            const urlListTextarea = document.getElementById('urlList');
            const fileInput = document.getElementById('fileInput');
            const apiKeyInput = document.getElementById('apiKey');
            const startButton = document.getElementById('startButton');
            const stopButton = document.getElementById('stopButton');
            const resultsDiv = document.getElementById('results');
            const logEntriesDiv = document.getElementById('logEntries');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const etaDisplay = document.getElementById('eta');
            
            let urls = [];
            let isRunning = false;
            let shouldStop = false;
            let processedCount = 0;
            let startTime = null;
            let avgTimePerUrl = null;
            
            // Translation dictionary
            const translations = {
                "URL already archived": {
                    "en": "URL already archived",
                    "zh": "網址已備份"
                },
                "Already archived on": {
                    "en": "Already archived on",
                    "zh": "已於下列時間備份"
                },
                "View archive": {
                    "en": "View archive",
                    "zh": "查看備份"
                },
                "Archive status check failed": {
                    "en": "Archive status check failed",
                    "zh": "備份狀態檢查失敗"
                },
                "Could not automatically check archive status. You can manually check at": {
                    "en": "Could not automatically check archive status. You can manually check at",
                    "zh": "無法自動檢查備份狀態，您可以手動檢查於"
                },
                "Archive request sent": {
                    "en": "Archive request sent",
                    "zh": "備份請求已送出"
                },
                "Waiting for 5 seconds before verifying...": {
                    "en": "Waiting for 5 seconds before verifying...",
                    "zh": "等待 5 秒後進行驗證..."
                },
                "Verification attempt": {
                    "en": "Verification attempt",
                    "zh": "驗證嘗試"
                },
                "Archive verification failed": {
                    "en": "Archive verification failed",
                    "zh": "備份驗證失敗"
                },
                "Archive request was sent but could not be verified.": {
                    "en": "Archive request was sent but could not be verified.",
                    "zh": "備份請求已送出但無法驗證。"
                },
                "It may still be processing - check manually later at": {
                    "en": "It may still be processing - check manually later at",
                    "zh": "可能仍在處理中 - 稍後可手動檢查於"
                },
                "Archive request failed": {
                    "en": "Archive request failed",
                    "zh": "備份請求失敗"
                },
                "CORS issue detected": {
                    "en": "CORS issue detected",
                    "zh": "偵測到 CORS 問題"
                },
                "Try archiving manually using the link below.": {
                    "en": "Try archiving manually using the link below.",
                    "zh": "請使用下方連結手動備份。"
                },
                "Archived": {
                    "en": "Archived",
                    "zh": "已備份"
                },
                "Warning": {
                    "en": "Warning",
                    "zh": "警告"
                },
                "Failed": {
                    "en": "Failed",
                    "zh": "失敗"
                },
                "Processing": {
                    "en": "Processing",
                    "zh": "處理中"
                },
                "Unknown": {
                    "en": "Unknown",
                    "zh": "未知"
                },
                "Expand": {
                    "en": "Expand",
                    "zh": "展開"
                },
                "Collapse": {
                    "en": "Collapse",
                    "zh": "收合"
                },
                "View": {
                    "en": "View",
                    "zh": "查看"
                },
                "Try archiving manually": {
                    "en": "Try archiving manually",
                    "zh": "嘗試手動備份"
                },
                "Stopping the process...": {
                    "en": "Stopping the process...",
                    "zh": "正在停止處理..."
                },
                "Please enter URLs or upload a file.": {
                    "en": "Please enter URLs or upload a file.",
                    "zh": "請輸入網址或上傳檔案。"
                },
                "No valid URLs found.": {
                    "en": "No valid URLs found.",
                    "zh": "沒有找到有效的網址。"
                },
                "Process stopped by user.": {
                    "en": "Process stopped by user.",
                    "zh": "使用者已停止處理。"
                },
                "All URLs have been processed!": {
                    "en": "All URLs have been processed!",
                    "zh": "所有網址已處理完成！"
                },
                "Error:": {
                    "en": "Error:",
                    "zh": "錯誤："
                },
                "Estimated time remaining:": {
                    "en": "Estimated time remaining:",
                    "zh": "預估剩餘時間："
                },
                "Complete!": {
                    "en": "Complete!",
                    "zh": "完成！"
                },
                "Estimating...": {
                    "en": "Estimating...",
                    "zh": "估計中..."
                }
            };
            
            // Function to get translation
            function translate_old(text, lang = document.body.getAttribute('lang') || 'en') {
                if (translations[text] && translations[text][lang]) {
                    return translations[text][lang];
                }
                
                // For strings with variable parts like "Verification attempt 1/3..."
                for (const key in translations) {
                    if (text.includes(key)) {
                        return text.replace(key, translations[key][lang]);
                    }
                }
                
                return text;
            }

            function translate(text, lang) {
                // 確保 lang 參數有值，優先使用傳入的，其次用 body 的 lang 屬性，最後默認為 'en'
                lang = lang || document.body.getAttribute('lang') || 'en';

                // 直接匹配完整文本
                if (translations[text] && translations[text][lang]) {
                    return translations[text][lang];
                }

                // 處理包含變量的文本 (改進部分匹配邏輯)
                let translatedText = text;
                for (const key in translations) {
                    if (text.includes(key) && translations[key][lang]) {
                        // 使用全局替換，替換所有匹配項
                        translatedText = translatedText.replace(new RegExp(key, 'g'), translations[key][lang]);
                    }
                }

                // 如果進行了任何替換，返回替換後的文本
                if (translatedText !== text) {
                    return translatedText;
                }

                // 如果還是沒有找到匹配，檢查是否有 fallback 機制
                // 如果在中文模式但沒有中文翻譯，可以考慮記錄這些缺失的翻譯
                if (lang === 'zh' && process.env.NODE_ENV === 'development') {
                    console.warn(`Missing Chinese translation for: "${text}"`);
                }

                return text;
            }
            
            // Observe language changes to update UI elements dynamically
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'lang') {
                        // Update all detail toggles
                        document.querySelectorAll('.details-toggle').forEach(function(toggle) {
                            const detailsRow = toggle.closest('tr').nextElementSibling;
                            const isExpanded = detailsRow && detailsRow.style.display === 'table-row';
                            toggle.textContent = isExpanded ? translate('Collapse') : translate('Expand');
                        });
                        
                        // Update all status labels
                        document.querySelectorAll('.status-label').forEach(function(label) {
                            if (label.classList.contains('status-success')) {
                                label.textContent = translate('Archived');
                            } else if (label.classList.contains('status-warning')) {
                                label.textContent = translate('Warning');
                            } else if (label.classList.contains('status-error')) {
                                label.textContent = translate('Failed');
                            } else if (label.classList.contains('status-info')) {
                                label.textContent = translate('Processing');
                            }
                        });
                        
                        // Update all "View" links
                        document.querySelectorAll('a').forEach(function(link) {
                            if (link.textContent === 'View' || link.textContent === '查看') {
                                link.textContent = translate('View');
                            } else if (link.classList.contains('manual-archive-link')) {
                                link.textContent = translate('Try archiving manually');
                            }
                        });
                        
                        // Update ETA text if shown
                        const eta = document.getElementById('eta');
                        if (eta.textContent.includes('Estimated time remaining') || 
                            eta.textContent.includes('預估剩餘時間')) {
                            const timeStr = eta.textContent.match(/\d+m \d+s/);
                            if (timeStr) {
                                eta.textContent = `${translate('Estimated time remaining:')} ${timeStr[0]}`;
                            }
                        } else if (eta.textContent === 'Complete!' || eta.textContent === '完成！') {
                            eta.textContent = translate('Complete!');
                        } else if (eta.textContent === 'Estimating...' || eta.textContent === '估算中...') {
                            eta.textContent = translate('Estimating...');
                        }
                    }
                });
            });
            
            observer.observe(document.body, { attributes: true });
            
            // Listen for file uploads
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    // For both CSV and TXT, we'll just extract anything that looks like a URL
                    const extractedUrls = content.match(/https?:\/\/[^\s,;"']+/g) || [];
                    urlListTextarea.value = extractedUrls.join('\n');
                };
                reader.readAsText(file);
            });
            
            // Start archiving process
            startButton.addEventListener('click', async function() {
                const apiKey = apiKeyInput.value.trim();
                const urlText = urlListTextarea.value.trim();
                
                if (!urlText) {
                    alert(translate('Please enter URLs or upload a file.'));
                    return;
                }
                
                urls = urlText.split('\n').filter(url => url.trim()).map(url => url.trim());
                
                if (urls.length === 0) {
                    alert(translate('No valid URLs found.'));
                    return;
                }
                
                // Reset UI
                isRunning = true;
                shouldStop = false;
                processedCount = 0;
                startTime = Date.now();
                avgTimePerUrl = null;
                
                startButton.style.display = 'none';
                stopButton.style.display = 'inline-block';
                resultsDiv.style.display = 'block';
                const statusTableBody = document.getElementById('statusTableBody');
                statusTableBody.innerHTML = '';
                progressContainer.style.display = 'block';
                progressBar.style.width = '0%';
                progressBar.textContent = '0%';
                etaDisplay.textContent = translate('Estimating...');
                
                // Log API key status
                if (apiKey) {
                    console.log('Using provided API key for requests');
                } else {
                    console.log('No API key provided, using public access (rate limits may apply)');
                }
                
                try {
                    await processUrls(urls, apiKey);
                    if (shouldStop) {
                        alert(translate('Process stopped by user.'));
                    } else {
                        alert(translate('All URLs have been processed!'));
                    }
                } catch (error) {
                    console.error(`${translate('Error:')} ${error.message}`);
                    alert(`${translate('Error:')} ${error.message}`);
                }
                
                // Reset UI
                isRunning = false;
                startButton.style.display = 'inline-block';
                stopButton.style.display = 'none';
            });
            
            // Stop the archiving process
            stopButton.addEventListener('click', function() {
                shouldStop = true;
                addLogEntry(translate('Stopping the process...'), 'warning');
            });
            
            // Process all URLs
            async function processUrls(urls, apiKey) {
                for (let i = 0; i < urls.length; i++) {
                    if (shouldStop) break;
                    
                    const url = urls[i];
                    
                    try {
                        // First check if the URL is already archived, then archive if needed
                        await archiveUrl(url, apiKey);
                    } catch (error) {
                        console.error(`Error processing ${url}:`, error);
                        // Error handling is done inside archiveUrl
                    }
                    
                    // Update progress
                    processedCount++;
                    const progress = Math.round((processedCount / urls.length) * 100);
                    progressBar.style.width = `${progress}%`;
                    progressBar.textContent = `${progress}%`;
                    
                    // Update ETA
                    const elapsedTime = Date.now() - startTime;
                    const timePerUrl = elapsedTime / processedCount;
                    
                    // Use a weighted average for more stable ETA
                    avgTimePerUrl = avgTimePerUrl === null 
                        ? timePerUrl 
                        : avgTimePerUrl * 0.7 + timePerUrl * 0.3;
                    
                    const remainingUrls = urls.length - processedCount;
                    const estimatedTimeRemaining = avgTimePerUrl * remainingUrls;
                    
                    if (remainingUrls > 0) {
                        const minutes = Math.floor(estimatedTimeRemaining / 60000);
                        const seconds = Math.floor((estimatedTimeRemaining % 60000) / 1000);
                        etaDisplay.textContent = `${translate('Estimated time remaining:')} ${minutes}m ${seconds}s`;
                    } else {
                        etaDisplay.textContent = translate('Complete!');
                    }
                    
                    // Add a small delay to prevent overwhelming the API
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
            
            // Check if a URL is already archived
            async function checkIfArchived(url) {
                try {
                    // The availability API usually doesn't have CORS issues
                    const response = await fetch(`https://archive.org/wayback/available?url=${encodeURIComponent(url)}`);
                    if (!response.ok) {
                        throw new Error(`HTTP error ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log("Archive check response:", data);
                    
                    const isArchived = data && 
                                     data.archived_snapshots && 
                                     data.archived_snapshots.closest && 
                                     data.archived_snapshots.closest.available === true;
                    
                    if (isArchived) {
                        // Extract archive URL and date
                        const archiveUrl = data.archived_snapshots.closest.url;
                        const timestamp = data.archived_snapshots.closest.timestamp;
                        
                        // Format the timestamp (YYYYMMDDHHMMSS) to a readable date
                        const year = timestamp.slice(0, 4);
                        const month = timestamp.slice(4, 6);
                        const day = timestamp.slice(6, 8);
                        const hour = timestamp.slice(8, 10);
                        const minute = timestamp.slice(10, 12);
                        const second = timestamp.slice(12, 14);
                        
                        const formattedDate = `${year}-${month}-${day} ${hour}:${minute}:${second}`;
                        
                        // Add an entry with the URL as the main text and the details in the expandable area
                        const details = `${translate('Already archived on')} ${formattedDate}\n${translate('View archive')}: ${archiveUrl}`;
                        addLogEntry(translate('URL already archived'), 'success', url, details);
                    }
                    
                    return isArchived;
                } catch (error) {
                    console.error("Error checking archive status:", error);
                    // If there's still a CORS issue, provide an alternative way to check
                    const checkUrl = `https://web.archive.org/web/*/${url}`;
                    const details = `${translate('Could not automatically check archive status. You can manually check at')}: ${checkUrl}`;
                    addLogEntry(translate('Archive status check failed'), 'warning', url, details);
                    
                    // Return false to proceed with archiving attempt
                    return false;
                }
            }
            
            // Archive a URL using the Wayback Machine API (CORS-friendly approach)
            async function archiveUrl(url, apiKey) {
                try {
                    // First, check if it's already archived
                    const isAlreadyArchived = await checkIfArchived(url);
                    if (isAlreadyArchived) {
                        return;
                    }

                    // Prepare fetch options
                    const fetchOptions = {
                        method: 'GET',
                        mode: 'no-cors'
                    };

                    // Add authorization header if API key is provided
                    if (apiKey) {
                        fetchOptions.headers = {
                            'Authorization': `LOW ${apiKey}`
                        };
                    }

                    // Use no-cors mode for the request
                    await fetch(`https://web.archive.org/save/${url}`, fetchOptions);

                    // Add a "processing" entry to the table
                    const waitingLogEntry = addLogEntry(translate('Archive request sent'), 'info', url, translate('Waiting for 5 seconds before verifying...'));
                    await new Promise(resolve => setTimeout(resolve, 5000));

                    // Check if it was archived (with retries)
                    let verificationSuccess = false;
                    let verificationDetails = '';

                    for (let attempt = 1; attempt <= 3; attempt++) {
                        const attemptMessage = `${translate('Verification attempt')} ${attempt}/3...`;

                        // Update verification details
                        verificationDetails += (verificationDetails ? '\n' : '') + attemptMessage;

                        // Update the details content if possible
                        if (waitingLogEntry && waitingLogEntry.detailsDiv) {
                            waitingLogEntry.detailsDiv.innerHTML = `<strong>${translate('Archive request sent')}</strong><div style="margin-top: 8px;">${verificationDetails}</div>`;
                        }

                        const checkResult = await checkIfArchived(url);
                        if (checkResult) {
                            verificationSuccess = true;
                            break;
                        }

                        // If not found and we have more attempts, wait and try again
                        if (attempt < 3) {
                            await new Promise(resolve => setTimeout(resolve, 2000));
                        }
                    }

                    if (!verificationSuccess) {
                        // Create a manual archive link for the user
                        const archiveUrl = `https://web.archive.org/save/${url}`;
                        verificationDetails += `\n\n${translate('Archive request was sent but could not be verified.')}`;
                        verificationDetails += `\n${translate('It may still be processing - check manually later at')}: ${archiveUrl}`;

                        addLogEntry(translate('Archive verification failed'), 'warning', url, verificationDetails);
                    }
                } catch (error) {
                    console.error("Error during archiving:", error);

                    // Handle CORS errors or other issues
                    const archiveUrl = `https://web.archive.org/save/${url}`;
                    const errorDetails = `${translate('CORS issue detected')}: ${error.message}\n${translate('Try archiving manually using the link below.')}`;

                    addLogEntry(translate('Archive request failed'), 'error', url, errorDetails);
                }
            }

            // Add a log entry to the results table
            function addLogEntry(message, type, url = null, details = null) {
                // Get the status table body
                const tableBody = document.getElementById('statusTableBody');

                // If this is a system message (no URL), handle differently
                if (!url) {
                    console.log(`[${type.toUpperCase()}] ${message}`);
                    return {entry: null, detailsDiv: null};
                }

                // Find if we already have an entry for this URL
                let existingRow = null;
                const rows = tableBody.getElementsByTagName('tr');
                for (let i = 0; i < rows.length; i++) {
                    if (rows[i].dataset.url === url) {
                        existingRow = rows[i];
                        break;
                    }
                }

                // If no existing row, create a new one
                if (!existingRow) {
                    // Count current rows for numbering
                    const rowNumber = tableBody.getElementsByTagName('tr').length / 2 + 1;

                    // Create main row
                    const row = document.createElement('tr');
                    row.dataset.url = url;
                    row.className = 'status-row';

                    // Add number cell
                    const numberCell = document.createElement('td');
                    numberCell.textContent = rowNumber;
                    row.appendChild(numberCell);

                    // Add URL cell

                    // Update the status cell with current status
                    const statusCell = existingRow.children[2];
                    const statusLabel = document.createElement('span');
                    statusLabel.className = `status-label status-${type}`;

                    let statusText = '';
                    switch (type) {
                        case 'success':
                            statusText = 'Archived';
                            break;
                        case 'warning':
                            statusText = 'Warning';
                            break;
                        case 'error':
                            statusText = 'Failed';
                            break;
                        case 'info':
                            statusText = 'Processing';
                            break;
                        default:
                            statusText = 'Unknown';
                    }

                    statusLabel.textContent = statusText;
                    statusCell.innerHTML = '';
                    statusCell.appendChild(statusLabel);

                    // Update details content
                    const detailsRow = existingRow.nextElementSibling;
                    const detailsContentCell = detailsRow.firstChild;

                    // Add the main message
                    const messageElement = document.createElement('div');
                    messageElement.innerHTML = `<strong>${message}</strong>`;

                    // Clear previous details when updating status
                    detailsContentCell.innerHTML = '';
                    detailsContentCell.appendChild(messageElement);

                    // Add any additional details
                    if (details) {
                        const detailsElement = document.createElement('div');
                        detailsElement.style.marginTop = '8px';

                        if (typeof details === 'string') {
                            // Check for URLs and make them clickable
                            if (details.includes('https://web.archive.org/')) {
                                // Split by newlines first to handle multiple lines
                                const lines = details.split('\n');
                                for (const line of lines) {
                                    const lineElement = document.createElement('div');

                                    if (line.includes('https://web.archive.org/')) {
                                        // This line contains a URL - make it clickable
                                        const urlMatch = line.match(/(https:\/\/web\.archive\.org\/[^\s]+)/);
                                        if (urlMatch) {
                                            const url = urlMatch[1];
                                            const beforeUrl = line.substring(0, line.indexOf(url));
                                            const afterUrl = line.substring(line.indexOf(url) + url.length);

                                            lineElement.textContent = beforeUrl;

                                            const linkElement = document.createElement('a');
                                            linkElement.href = url;
                                            linkElement.textContent = url;
                                            linkElement.target = '_blank';
                                            lineElement.appendChild(linkElement);

                                            lineElement.appendChild(document.createTextNode(afterUrl));

                                            // If this contains the archive URL, also update the "View Archive" cell
                                            if (line.includes('View archive') || line.includes('Already archived')) {
                                                const viewCell = existingRow.children[3];
                                                viewCell.innerHTML = '';

                                                const viewLink = document.createElement('a');
                                                viewLink.href = url;
                                                viewLink.textContent = 'View';
                                                viewLink.target = '_blank';
                                                viewCell.appendChild(viewLink);
                                            }
                                        } else {
                                            lineElement.textContent = line;
                                        }
                                    } else {
                                        lineElement.textContent = line;
                                    }

                                    detailsElement.appendChild(lineElement);
                                }
                            } else {
                                // Regular text without URLs
                                detailsElement.innerText = details;
                            }
                        } else if (typeof details === 'object') {
                            // JSON data
                            const pre = document.createElement('pre');
                            pre.textContent = JSON.stringify(details, null, 2);
                            detailsElement.appendChild(pre);
                        }

                        detailsContentCell.appendChild(detailsElement);
                    }

                    // Auto-expand for errors and warnings
                    if (type === 'error' || type === 'warning') {
                        detailsRow.style.display = 'table-row';
                        const detailsToggle = existingRow.querySelector('.details-toggle');
                        if (detailsToggle) {
                            detailsToggle.textContent = 'Collapse';
                        }
                    }

                    // For manual archive links in error/warning cases
                    if (type === 'error' || type === 'warning') {
                        // Create a container for manual links if needed
                        let manualLinkContainer = detailsContentCell.querySelector('.manual-link-container');
                        if (!manualLinkContainer) {
                            manualLinkContainer = document.createElement('div');
                            manualLinkContainer.className = 'manual-link-container';
                            manualLinkContainer.style.marginTop = '10px';
                            detailsContentCell.appendChild(manualLinkContainer);
                        }

                        // Add manual archive link if not already added
                        if (!manualLinkContainer.querySelector('.manual-archive-link')) {
                            const archiveUrl = `https://web.archive.org/save/${url}`;
                            const linkElement = document.createElement('a');
                            linkElement.href = archiveUrl;
                            linkElement.className = 'manual-archive-link';
                            linkElement.textContent = 'Try archiving manually';
                            linkElement.target = '_blank';
                            linkElement.style.display = 'inline-block';
                            linkElement.style.marginTop = '5px';
                            linkElement.style.color = '#0066cc';
                            manualLinkContainer.appendChild(linkElement);
                        }
                    }

                    // Log to console as well
                    console.log(`[${type.toUpperCase()}] ${url}: ${message}`);

                    // Return elements that might be needed for updates
                    return {
                        entry: existingRow,
                        detailsDiv: detailsContentCell
                    };
                }
            }
        })
        
    </script>
</body>
</html>